---
title: "ë”°ë¦‰ì´ ë°ì´í„° ë¶„ì„í•˜ê¸° (7) - AutoML"
tags:
- Project
- AutoML
- PyCaret
- Python
category: Project
use_math: true
header: 
 teaser: /assets/img/ë”°ë¦‰ì´_AutoML_3.jpg
---
{% raw %}
## ë”°ë¦‰ì´ ë°ì´í„° ë¶„ì„í•˜ê¸° (7) - AutoML

ì´ë²ˆ ê²Œì‹œê¸€ì„ ëìœ¼ë¡œ ë°ì´ì½˜ì˜ ë”°ë¦‰ì´ ë°ì´í„° ë¶„ì„ ê´€ë ¨ í¬ìŠ¤íŒ…ì„ ë§ˆì¹˜ê³ ì í•œë‹¤. ë§ˆì§€ë§‰ ë‚´ìš©ì€ **AutoML**ì„ ë‹¤ë£° ê²ƒì¸ë°, AutoMLì´ë€ ì´ì „ì— ì‚´í´ë³¸ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ ëª¨ë¸ë“¤ì„ ì„ íƒí•˜ê³ , hyperparameterë“¤ì„ ìµœì í™”í•˜ëŠ” ì¼ë ¨ì˜ ëª¨ë“  ê³¼ì •ë“¤ì„ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ ì´ì¹­í•˜ëŠ” ë‹¨ì–´ì´ë‹¤. ì‚¬ì‹¤ ìµœê·¼ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ë¬´ ì˜ì—­ì—ì„œëŠ” AutoMLì´ ëŒ€ì„¸ë¡œ ìë¦¬ì¡ì•„ê°€ëŠ” ì¶”ì„¸ë¼ê³  í•œë‹¤. ì´ì „ê¹Œì§€ëŠ” ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ì„ íƒí•˜ê³  í•˜ì´í¼íŒŒë¼ë¯¸í„°ë¥¼ íŠœë‹í•˜ê¸° ìœ„í•´ ë§ì€ ì‹œê°„ì„ ì†Œë¹„í•´ì•¼ í–ˆìœ¼ë‚˜, AutoMLë¡œ ì´ëŸ¬í•œ ê³¼ì •ì„ ìë™í™”í•˜ì—¬ ë°ì´í„°ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸ë“¤ì€ ë°ì´í„°ì˜ ìˆ˜ì§‘, ì „ì²˜ë¦¬, ì‹¤í—˜ ì„¤ê³„ ë“± ë¶„ì„ì˜ ë³¸ì§ˆì ì¸ ì„±ëŠ¥ì„ ëŒì–´ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ì˜ì—­ì— ì¢€ ë” ì§‘ì¤‘í•˜ê²Œ ë˜ëŠ” ê²ƒì´ë‹¤. ë¿ë§Œ ì•„ë‹ˆë¼, ë¹„ì „ê³µìë‚˜ ë‹¤ë¥¸ ë¶„ì•¼(ì„œë¹„ìŠ¤ ê¸°íš, PM ë“±)ì— ì¢…ì‚¬í•˜ëŠ” ì‚¬ëŒë“¤ë„ ê°„ë‹¨í•œ ì½”ë“œ ëª‡ì¤„ë¡œ ì‰½ê²Œ ëª¨ë¸ë§ ê³¼ì •ì„ ì œê³µë°›ì„ ìˆ˜ ìˆë‹¤ëŠ” ì ì—ì„œ AutoMLì€ ì¶©ë¶„íˆ ë§¤ë ¥ì ì¸ ê¸°ìˆ ì´ë‹¤(ë¬¼ë¡  ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤ ì „ê³µìì—ê²ŒëŠ” ì‚¬ì‹¤ ê¸°ìœ ì†Œì‹ì€ ì•„ë‹ˆë‹¤ğŸ˜‚). AutoMLì€ ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ ì œê³µí•˜ëŠ”ë°, ì—¬ê¸°ì—ì„œëŠ” Pythonì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì‚¬ì´í‚·ëŸ° ê¸°ë°˜ì˜ `pycaret` íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•´ AutoMLì´ ì‘ë™í•˜ëŠ” ì „ë°˜ì ì¸ ê³¼ì •ì„ ì‚´í´ë³´ê³ ì í•œë‹¤. ì°¸ê³ ë¡œ, AutoMLì€ ì»´í“¨íŒ… ìì›ì„ ìƒë‹¹íˆ ìš”êµ¬í•˜ê¸° ë•Œë¬¸ì—, ì½”ë”©ì€ ë¡œì»¬ í™˜ê²½ì—ì„œ ì§„í–‰í•˜ë”ë¼ë„ GPUë‚˜ TPUë¥¼ ì§€ì›í•˜ëŠ” **Colab í™˜ê²½**ì—ì„œ í•™ìŠµì„ ì§„í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. *í•„ìë„ Colabì—ì„œ ì‹¤ìŠµì„ ì§„í–‰í–ˆë‹¤.*

### ë°ì´í„° ì¤€ë¹„ ë° ì „ì²˜ë¦¬
íŒ¨í‚¤ì§€ ë¡œë“œ ë° ë°ì´í„° ì¤€ë¹„ê³¼ì •ì€ ìƒëµí•˜ê¸°ë¡œ í•˜ê³ (Full code ì°¸ê³ ), ìš°ì„  ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ì„ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í–ˆë‹¤. ì‚¬ì‹¤ AutoMLì˜ ê²½ìš° ì „ì²˜ë¦¬ë¥¼ ë³„ë„ë¡œ ì§„í–‰í•˜ì§€ ì•Šì•„ë„, ë²”ì£¼ë¥¼ ìë™ìœ¼ë¡œ ì„ íƒí•˜ê³  ë°ì´í„° ë¶„í¬ì— ë§ê²Œë” ë³€ìˆ˜ë³€í™˜ì„ ì§„í—¹í•˜ê±°ë‚˜, one-hot encoding ë“±ë„ ì•Œì•„ì„œ ì§„í–‰í•´ì£¼ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì€ íŒŒì´í”„ë¼ì¸ì„ ìŠ¤ìŠ¤ë¡œ ë§Œë“¤ì§€ ì•Šì•„ë„ ëœë‹¤.
```py
# Data Preprocessing
numeric_features = list(df_X.columns.drop(['precip','hour']))
numeric_transformer = Pipeline(
    steps=[("imputer",SimpleImputer(strategy='median')),("scaler",StandardScaler())]
)
hour_feature = ['hour']
hour_transformer = Pipeline(
    steps=[("imputer",SimpleImputer(strategy='most_frequent'))]
 )

cat_feature = ['precip']
cat_transformer = Pipeline(
    steps=[("imputer",SimpleImputer(strategy="most_frequent"))]
)

preprocessor = ColumnTransformer(
    transformers=[
        ("num", numeric_transformer, numeric_features),
        ('hour', hour_transformer, hour_feature),
        ("cat", cat_transformer, cat_feature)
    ]
)

```
`pycaret`ì€ scikit-learn ê¸°ë°˜ì˜ ëª¨ë“ˆì´ì§€ë§Œ ì§ì ‘ íŒŒì´í”„ë¼ì¸ì„ êµ¬í˜„í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì „ì²˜ë¦¬ ê³¼ì •ì€ `preprocessor`ì„ ì´ìš©í•´ ì§ì ‘ ë°ì´í„°ë¥¼ transform í•´ì•¼ í•œë‹¤.
```py
X_train_p = pd.DataFrame(preprocessor.fit_transform(X_train))
X_val_p = pd.DataFrame(preprocessor.fit_transform(X_val))
```
`pycaret`ì€ ëª¨ë¸ ì„¤ì • ê³¼ì •ì—ì„œ ë°˜ì‘ë³€ìˆ˜ ë° ì˜ˆì¸¡ë³€ìˆ˜ê°€ ëª¨ë‘ í¬í•¨ëœ ë°ì´í„°í”„ë ˆì„ì„ ìš”êµ¬í•œë‹¤. ë”°ë¼ì„œ Transformed ëœ ì˜ˆì¸¡ë³€ìˆ˜ë“¤ê³¼ ë°˜ì‘ë³€ìˆ˜ ë²¡í„°ë¥¼ í•˜ë‚˜ì˜ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë§Œë“¤ì—ˆë‹¤.
```py
# Preprocessed data > to whole Dataframe
data_train = pd.concat([X_train_p,pd.Series(y_train)],axis=1)
data_test = pd.concat([X_val_p,pd.Series(y_val)],axis=1)

columns = numeric_features+hour_feature+cat_feature+['y']
data_train.columns = columns
data_test.columns = columns

data_train # 1021 * 10 columns
```

### AutoML Modeling
`pycaret`ì€ ë‹¤ìŒê³¼ ê°™ì´ `setup` í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ì–´ë– í•œ ì¡°ê±´ìœ¼ë¡œ AutoMLì„ ì§„í–‰í•  ê²ƒì¸ì§€ ì„¤ì •ë§Œ í•´ì£¼ë©´ ëª¨ë“  ì¤€ë¹„ê°€ ëë‚œë‹¤.
```py
# Pycaret env setup
reg_auto = setup(
    data = data_train, target = 'y', session_id = 100,
    normalize = True, transformation = True, transform_target = True, ## Response Variable normalize
    categorical_features=['precip'],
    remove_multicollinearity = True, ## ë‹¤ì¤‘ê³µì„ ì„± ì œê±°
    multicollinearity_threshold = 0.90,
    silent = True, use_gpu = True, log_experiment = True, experiment_name = 'logs' # ê¸°íƒ€ ì„¸íŒ…
)
```
ì²«ì¤„ì—ì„œëŠ” ë°ì´í„°í”„ë ˆì„ê³¼ íƒ€ê²Ÿ ë³€ìˆ˜(ë°˜ì‘ë³€ìˆ˜)ë¥¼ ì§€ì •í•´ì£¼ì—ˆë‹¤. ë˜í•œ, `session_id`ëŠ” ì‚¬ì´í‚·ëŸ°ì˜ `random_state`ì™€ ê°™ì´ í•™ìŠµê³¼ì •ì˜ randomnessë¥¼ ì œì–´í•˜ê²Œë” í•´ì£¼ëŠ” ë³€ìˆ˜ì´ë‹¤. ë‘˜ì§¸ì¤„ì˜ `normalize`ëŠ” ë³€ìˆ˜ì˜ ì •ê·œí™”ë¥¼ ì§„í–‰í•  ê²ƒì¸ì§€ ì„¤ì •í•˜ëŠ” ê²ƒì¸ë°, ì•ì„œ ì •ê·œí™”ë¥¼ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ  ì²˜ë¦¬í–ˆì§€ë§Œ ì—¬ê¸°ì„œë„ ì¼ë‹¨ `True`ë¡œ ì„¤ì •í–ˆë‹¤. `transformation = True`ëŠ” ë°ì´í„°ê°€ ì •ê·œë¶„í¬ í˜•íƒœë¥¼ ì·¨í•˜ë„ë¡ ë¡œê·¸ë³€í™˜ ë“±ì„ ìˆ˜í–‰í•˜ë„ë¡ í•˜ëŠ” ë³€ìˆ˜ì´ë©°, `transform_target`ì€ íƒ€ê²Ÿ ë³€ìˆ˜ì— ëŒ€í•œ ì •ê·œë³€í™˜ì„ ì˜ë¯¸í•œë‹¤. 
ë„¤ë²ˆì§¸ ì¤„ì˜ `remove_multicolinearity`ëŠ” ë‹¤ì¤‘ê³µì„ ì„±ì„ ì¼ìœ¼í‚¤ëŠ” ì˜ˆì¸¡ë³€ìˆ˜ë¥¼ ì œê±°í•  ê²ƒì¸ì§€ ì„¤ì •í•˜ëŠ” ë³€ìˆ˜ì¸ë°, ë‹¤ìŒ `threshold` ë³€ìˆ˜ì—ì„œ ê·¸ ê¸°ì¤€ì¹˜ë¥¼ ì„¤ì •í•œë‹¤(0.9). ì´ë°–ì—ë„, `pca = True` ë¥¼ ì„¤ì •í•˜ì—¬ ì°¨ì›ì¶•ì†Œë¥¼ ì§„í–‰í•  ê²ƒì¸ì§€, `remove_outliers = True`ë¥¼ ì„¤ì •í•˜ì—¬ ì´ìƒì¹˜ë¥¼ ì œê±°í•  ê²ƒì¸ì§€ ë“±ì„ ë³„ë„ë¡œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, `compare_models` í•¨ìˆ˜ë¥¼ ì´ìš©í•´ regressionì— ì‚¬ìš©ë˜ëŠ” ì•½ 20ê°œì˜ ëª¨ë¸ ì¢…ë¥˜ì— ëŒ€í•´ ëª¨ë¸ë§ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤. ì•„ë˜ ì½”ë“œëŠ” ê° ëª¨ë¸ì— ëŒ€í•œ 10-fold [cross validation](https://ddangchani.github.io/machine%20learning/Cross_Validation/)ì„ ì‹¤í–‰í•˜ì—¬ RMSEë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ì„±ëŠ¥ì´ ì¢‹ì€ ëª¨ë¸ ìˆœìœ¼ë¡œ ê²°ê³¼ë¥¼ ì •ë ¬í•œë‹¤.

```py
best = compare_models(sort = 'RMSE', fold = 10) # 10-fold CV
```
![](/assets/img/ë”°ë¦‰ì´_AutoML_0.jpg)

ìœ„ ê·¸ë¦¼ê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤(ì‹¤ì œ Colabì—ì„œì˜ ì‹¤í–‰ ê²°ê³¼). ì‹¤í–‰ ê²°ê³¼ Tree ê¸°ë°˜ì˜ ëª¨ë¸ì´(GBM í¬í•¨) ìƒëŒ€ì ìœ¼ë¡œ ì„±ëŠ¥ì´ ìš°ìˆ˜í•˜ê²Œ ë„ì¶œë˜ì—ˆëŠ”ë°, ì‹¤ì œë¡œ ì´ì „ê¹Œì§€ ì§ì ‘ ëª¨ë¸ë§ í•œ ì¶”ì„¸ë“¤ê³¼ ëŒ€ëµ ì¼ì¹˜í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì´ë²ˆì—ëŠ” ìš°ìˆ˜í•œ ê²°ê³¼ë¥¼ ë‚˜íƒ€ë‚¸ íŠ¹ì • ëª¨ë¸(Light GBM)ì— ëŒ€í•œ Tuning ê³¼ì •ì„ ì‚´í´ë³´ë„ë¡ í•˜ì.

### Specific Modeling
ìš°ì„  ì•ì„  setup ê³¼ì •ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì²´ì ì¸ light GBM ëª¨ë¸ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
```py
lightgbm = create_model('lightgbm', fold = 10) # 10-fold CV
```
ì´ë•Œ, `print(lightgbm)` ì½”ë“œë¡œ ëª¨ë¸ì„ ì¶œë ¥í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ëª¨ë¸ì—ì„œ ì„¤ì •ëœ hyperparameterë“¤ê³¼ ê°ì¢… ì„¤ì •ê°’ì— ëŒ€í•´ ì‚´í´ë³¼ ìˆ˜ ìˆë‹¤.
![](/assets/img/ë”°ë¦‰ì´_AutoML_1.jpg)

ì´ëŠ” ì•„ì§ êµ¬ì²´ì ì¸ ëª¨ë¸ `lightgbm`ì— ëŒ€í•´ì„œëŠ” í•˜ì´í¼íŒŒë¼ë¯¸í„° íŠœë‹ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šì€ ìƒíƒœì¸ë°, ì•„ë˜ ì½”ë“œë¡œ í•˜ì´í¼íŒŒë¼ë¯¸í„° íŠœë‹ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.
```py
tuned_lightgbm = tune_model(lightgbm)
```
ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ 10-CV ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆê³ (ìƒëµ), ì•ì„  ì½”ë“œì™€ ê°™ì´ ëª¨ë¸ì„ `print`í•´ í•˜ì´í¼íŒŒë¼ë¯¸í„° ë° ì„¤ì •ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

### Plots
ë˜í•œ, Regression ê²°ê³¼ì™€ ê´€ë ¨í•´ `pycaret`ì€ ì†ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì¼ë¶€ plotë“¤ì„ ì œê³µí•˜ê³  ìˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì€ residual plot, prediction error plot, feature importance plot([ì°¸ê³ ](https://ddangchani.github.io/Random-Forest))ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

```py
# Residual Plot
plot_model(tuned_lightgbm, plot="residuals")
```
![](/assets/img/ë”°ë¦‰ì´_AutoML_2.jpg)
```py
# Prediction Error Plot
plot_model(tuned_lightgbm, plot="error")
```
![](/assets/img/ë”°ë¦‰ì´_AutoML_3.jpg)

```py
# Feature Importance Plot
plot_model(tuned_lightgbm, plot="feature")
```
![](/assets/img/ë”°ë¦‰ì´_AutoML_4.jpg)

### Final Model
ë§ˆì§€ë§‰ìœ¼ë¡œ, ì´ë ‡ê²Œ ì–»ì€ ëª¨ë¸ì„ ë°”íƒ•ìœ¼ë¡œ train-test splitì„ ì´ìš©í•´ ë˜ë‹¤ë¥¸ í•™ìŠµ ê³¼ì •ì„ ê±°ì¹˜ëŠ” `finalize_model` í•¨ìˆ˜ë¥¼ ì ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ìµœì¢… ëª¨ë¸ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.
```py
# Model Finalizing

final_lightgbm = finalize_model(tuned_lightgbm)
print(final_lightgbm)
```
ë˜í•œ, ìµœì¢… ëª¨ë¸ë¡œ ì´ˆê¸° ì„¤ì •í–ˆë˜ validation ë°ì´í„° ì…‹ì— ëŒ€í•´ ê²€ì¦ ì˜¤ì°¨ë¥¼ êµ¬í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤. ë¨¼ì €, ì•„ë˜ ì½”ë“œë¥¼ í†µí•´ ê²€ì¦ ë°ì´í„°ì…‹ì— ëŒ€í•œ ì˜ˆì¸¡ê°’(Label)ì´ ì¶”ê°€ëœ ë°ì´í„°í”„ë ˆì„ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

```py
# Test dataset Prediction

test_predictions = predict_model(final_lightgbm, data = data_test)
test_predictions.head(5)
```
![](/assets/img/ë”°ë¦‰ì´_AutoML_5.jpg)

Validation dataset(`data_test`) ì— ëŒ€í•œ ìµœì¢… metricì€ ë‹¤ìŒê³¼ ê°™ì´ ê³„ì‚°í•  ìˆ˜ ìˆë‹¤.

```py
# Check Metric

from pycaret.utils import check_metric
check_metric(test_predictions.y, test_predictions.Label, "RMSE") # 39.4908
```



# References
- Pycaret ê³µì‹ ë¬¸ì„œ : https://pycaret.org
- Full Code on Github : https://github.com/ddangchani/project_ddareungi/blob/main/AutoML.ipynb
{% endraw %}